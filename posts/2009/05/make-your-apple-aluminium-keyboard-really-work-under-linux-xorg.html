<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
        

        <title>Make your Apple Aluminium Keyboard really work under Linux, X.org</title>

        <link href="https://dciabrin.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="(blog-dump 'dciabrin) Full Atom Feed" />
        <link href="https://dciabrin.net/feeds/apple-kbd.tag.atom.xml" type="application/atom+xml" rel="alternate" title="(blog-dump 'dciabrin) Tags Atom Feed" />
        <link href="https://dciabrin.net/feeds/apple.tag.atom.xml" type="application/atom+xml" rel="alternate" title="(blog-dump 'dciabrin) Tags Atom Feed" />


        <!-- Blog theme + Bootstrap compiled to CSS -->
        <link rel="stylesheet" href="https://dciabrin.net/theme/css/blogtheme.css?6f5403ff">

        <!-- Code highlight color scheme -->
            <link href="https://dciabrin.net/theme/css/code_blocks/friendly.css" rel="stylesheet">

        <!--  -->

        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">



        <meta name="description" content="Like many others, I've bought an Aluminium Keyboard for ~~its cool style~~ the smooth typing experience it provides. Mine is a wired...">

        <meta name="author" content="Damien Ciabrini">

        <meta name="tags" content="apple-kbd">
        <meta name="tags" content="apple">

	                <meta property="og:locale" content="">
		<meta property="og:site_name" content="(blog-dump 'dciabrin)">

	<meta property="og:type" content="article">
            <meta property="article:author" content="https://dciabrin.net/author/damien-ciabrini.html">
	<meta property="og:url" content="https://dciabrin.net/posts/2009/05/make-your-apple-aluminium-keyboard-really-work-under-linux-xorg.html">
	<meta property="og:title" content="Make your Apple Aluminium Keyboard really work under Linux, X.org">
	<meta property="article:published_time" content="2009-05-15 00:16:00.013000+02:00">
            <meta property="og:description" content="Like many others, I've bought an Aluminium Keyboard for ~~its cool style~~ the smooth typing experience it provides. Mine is a wired...">

            <meta property="og:image" content="https://dciabrin.net/img/covers/big-dodzy-59J9tB7KoOU-unsplash.jpg">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@dciabrin">
        <meta name="twitter:title" content="Make your Apple Aluminium Keyboard really work under Linux, X.org">

            <meta name="twitter:image" content="https://dciabrin.net/theme/images/post-bg.jpg">

            <meta name="twitter:description" content="Like many others, I've bought an Aluminium Keyboard for ~~its cool style~~ the smooth typing experience it provides. Mine is a wired...">
    <link rel="icon" href="/favicon.ico">
</head>

<body class="article-make-your-apple-aluminium-keyboard-really-work-under-linux-xorg">

    <!-- Navigation -->
    <nav class="navbar navbar-light navbar-expand-lg navbar-customz navbar-fixed-topz">
        <!-- <div class="container-fluid"> -->
            <!-- Brand and toggle get grouped for better mobile display -->
            <!-- <div class="navbar-header page-scroll"> -->
                <a class="navbar-brand" href="https://dciabrin.net/">(blog-dump 'dciabrin)</a>
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="navbar-toggler-icon"></span>
                </button>
            <!-- </div> -->

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="navbar-nav flex-row ml-md-auto d-md-flex">

                            <li><a class="nav-link" href="https://dciabrin.net/pages/about.html">About</a></li>
                </ul>
                <ul class="navbar-nav">
                  <li><a class="nav-link" href="#"><i class="fa fa-search"></i></a></li>
                  <li><a class="nav-link" href="/tags"><i class="fa fa-tags"></i></a></li>
                  <li><a class="nav-link" href="#"><i class="fa fa-rss"></i></a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        <!-- </div> -->
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <header class="intro-header">
        <div id="header-background" style="background-image: url('https://dciabrin.net/img/covers/alex-knight-Ys-DBJeX0nE-unsplash.jpg'); --parallax-ratio: 1.500;">
        </div>
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-md-12">
                    <div class="post-heading">
                        <!-- <i class="fa fa-calendar" aria-hidden="true"></i>&nbsp; -->
                        <span class="text-light meta">Fri 15 May 2009</span>
                        <h1 class="text-light">Make your Apple Aluminium Keyboard really work under Linux, X.org</h1>
                        <span class="meta">
                          &nbsp;
                          <a class="btn btn-outline-secondary btn-sm" href="https://dciabrin.net/tag/apple-kbd.html"><i class="fa fa-tag" aria-hidden="true"></i> APPLE-KBD</a>
&nbsp;                          <a class="btn btn-outline-secondary btn-sm" href="https://dciabrin.net/tag/apple.html"><i class="fa fa-tag" aria-hidden="true"></i> APPLE</a>
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container-fluid">
    <!-- Post Content -->
    <div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
        <article>
            <p>Like many others, I've bought an Aluminium Keyboard for ~~its cool
style~~ the smooth typing experience it provides. Mine is a wired
version, ISO variant (international, 110-keys). It's not working 100%
out-of-the-box under Linux, so this post explains what I did to make it
happen:</p>
<ul>
<li>
<p>Supporting the additional keys (F13..F19) and geometry (physical
    layout) under X.org</p>
</li>
<li>
<p>Making the keyboard auto-configured at X.org startup. No need to
    mess with xorg.conf!</p>
</li>
</ul>
<p>But wait, there's more. If you're accustomed to PC keyboards, you really
need those ones too:</p>
<ul>
<li>
<p><strong>Making this fn key located on top of the delete key behave like a
    regular PC keyboard: Insert!</strong></p>
</li>
<li>
<p>Making multimedia keys output Fxx symbols by default</p>
</li>
<li>
<p>Making F13..F15 behave like those charmingly obsolete Scroll
    Lock..Print Screen keys</p>
</li>
<li>
<p>Keeping the multimedia keys accessible when the fn key is remapped
    to Insert</p>
</li>
</ul>
<!-- PELICAN_END_SUMMARY -->

<h2>Prerequisite</h2>
<p>First, make sure you have installed all the packages below and that
their versions are recent enough:</p>
<ul>
<li><a href="http://www.freedesktop.org/wiki/Software/Xserver">xserver-xorg</a>
    v1.5.2, X.org's hotplug-aware X server</li>
<li><a href="http://cgit.freedesktop.org/xorg/driver/xf86-input-evdev">xserver-xorg-input-evdev</a>
    v2.0.xx, evdev driver for input devices</li>
<li><a href="http://www.freedesktop.org/wiki/Software/hal">HAL</a> v0.5.xx, the
    hardware abstraction layer daemon which gives hotplug information to
    the X server</li>
</ul>
<h2>How the support works</h2>
<h3>Install</h3>
<p>Go grab <a href="http://damien.ciabrini.free.fr/pub/apple-alu-kbd/xkb-apple-aluminium-kdb-iso.patch.gz">this
patch</a>
and save it in your home directory; it contains the relevant XKB updates
to support the keymap and the geometry of Apple Aluminium keyboard, ISO
variant. It also defines two XKB options to make this keyboard behave
more like a PC keyboard (more on that later). To install it, first
<em>pretend</em> to apply the patch in the directory that holds the XKB data.
On my Ubuntu, this gives:</p>
<div class="highlight"><pre><span></span><code><span class="go">sudo bash</span>
<span class="go">cd /usr/share/X11/xkb</span>
<span class="go">gunzip -cd $HOME/xkb-apple-aluminium-kdb-iso.patch.gz | patch -p1 --dry-run</span>
</code></pre></div>


<p>If the patch applies successfuly, you can proceed and apply it for real:</p>
<div class="highlight"><pre><span></span><code><span class="go">gunzip -cd $HOME/xkb-apple-aluminium-kdb-iso.patch.gz | patch -p1</span>
</code></pre></div>


<p>Once you have the relevant XKB definition for your keyboard, you need to
tell X.org to apply these settings automatically when it detects your
keyboard. <a href="http://damien.ciabrini.free.fr/pub/apple-alu-kbd/10-apple-aluminium-kbd.fdi">The following HAL fdi
file</a>
makes the necessary voodoo (read: XKB settings) for you. Note that these
settings do not preclude your system-wide XKB options.</p>
<p>In order to install the fdi file I'm providing, just copy it in the HAL
directory which holds user-defined policies for devices. On my Ubuntu,
this directory is <code>/usr/share/hal/fdi/policy/30user</code>. You might need to
create <code>30user</code> if it doesn't exist.</p>
<h3>Test</h3>
<p>Now that you installed everything, restart HAL. For example, on a
Debian-like distro:</p>
<div class="highlight"><pre><span></span><code><span class="go">sudo /etc/init.d/hal restart</span>
</code></pre></div>


<p>Then log out from your current X session and start a new one. If
everything went well, you should now be able to see the Aluminium
Keyboard in your keyboard preferences application. The screenshots below
show the result under GNOME:</p>
<p><img alt="preferences" src="https://dciabrin.net/posts/2009/05/alukbd-preferences.png">
<img alt="geometry" src="https://dciabrin.net/posts/2009/05/alukbd-geometry.png"></p>
<h2>Make it a PC keyboard!</h2>
<h3>The Insert key hack</h3>
<p>The fn key is not seen by X because its keycode (464) is greater than
255, <a href="http://bugs.freedesktop.org/show_bug.cgi?id=x11-keycode-limit">which is not
allowed</a>
in X11 protocol. But there is a trick: under Linux, you can modify the
kernel scancode→keycode mapping of your evdev device!</p>
<p>Just uncomment the two optional lines in the <a href="http://damien.ciabrini.free.fr/pub/apple-alu-kbd/10-apple-aluminium-kbd.fdi">fdi
file</a>
I'm providing to make the fn scancode (HID usage 0xff0003 on this
keyboard) generate the Insert keycode (110) in userland and make Xorg
happy :D</p>
<p>For curious people:
<a href="http://thread.gmane.org/gmane.comp.freedesktop.hal/8615/focus=8615">Initially</a>
(funny how these names look familiar if you read
<a href="http://planet.gnome.org/">p.g.o</a>...), HAL's keycode remapping seems to
have been designed with <a href="http://www.win.tue.nl/%7Eaeb/linux/kbd/scancodes-1.html">AT
scancodes</a> in
mind, not HID usages. In order to override those ones, you must <a href="http://thread.gmane.org/gmane.comp.freedesktop.hal/8615/focus=8687">revert
a special
encoding</a>
performed for representing AT escape scancodes. In our case, you end up
remapping usage 0xffdf83!</p>
<h3>Fxx keys enabled by default</h3>
<p>This one is not new. In order to boot with Fxx keys enabled, you must
pass an option to the <code>hid</code> Linux module. On my Ubuntu, this can be done
by updating modprobe options and rebuilding an <code>initrd</code> image.</p>
<div class="highlight"><pre><span></span><code><span class="go">sudo bash</span>
<span class="go">echo &quot;options hid pb_fnmode=2&quot; &gt;&gt; /etc/modprobe.d/alukbd</span>
<span class="go">echo &quot;options hid_apple fnmode=2&quot; &gt;&gt; /etc/modprobe.d/alukbd</span>
<span class="go">update-initramfs -k `uname -r` -u</span>
</code></pre></div>


<h3>Additional PC-like XKB options</h3>
<p>The XKB patch I'm providing defines two new XKB options:</p>
<dl>
<dt><code>apple:alupcfkeys</code></dt>
<dd>If you need to map F13..F15 to Scroll Lock..Print Screen keys (I
won't judge you, I swear :P)</dd>
<dt><code>apple:alul3media</code></dt>
<dd>If you remap fn to Insert, this options allows you to access the
multimedia keys is by typing 3rd-level chooser + Fxx key. I've
mapped my 3rd-level chooser to the right Alt key (XKB option
<code>lv3:ralt_switch</code> )</dd>
</dl>
<p>Naturally, the simplest way of using these XKB options is to enable them
via your keyboard preferences application. For instance, GNOME users can
find them in the Keyboard Layout Options:</p>
<p><img alt="options" src="https://dciabrin.net/posts/2009/05/alukbd-options.png"></p>
<h2>Conclusion</h2>
<p>My XKB and HAL settings provide complete support for your Aluminium
Keyboard on Xorg Linux. However, the Insert key hack is probably not
mainstream and ultimately should not land in a fdi file. It would be
better to make a distro package such as “enable PC-support on Aluminium
Keyboard”.</p>
<p>The XKB geometry implemented is for the ISO variant. if you have one of
the other variant and like to throw it away, you know I'd be happy to
add support for it, eheh :P</p>
        </article>
    </div>
    </div>

    <div class="sharing row justify-content-center">
      <div class="col text-center">
        <span class="meta text-uppercase share">share</span>
        <a href="https://twitter.com/intent/tweet?text=Make%20your%20Apple%20Aluminium%20Keyboard%20really%20work%20under%20Linux%2C%20X.org&url=https%3A//dciabrin.net/posts/2009/05/make-your-apple-aluminium-keyboard-really-work-under-linux-xorg.html&hashtags=apple-kbd,apple" target="_blank"><i class="fa fa-twitter-square" aria-hidden="true"></i></a>
        <a href="https://www.reddit.com/submit?url=https%3A//dciabrin.net/posts/2009/05/make-your-apple-aluminium-keyboard-really-work-under-linux-xorg.html&title=Make%20your%20Apple%20Aluminium%20Keyboard%20really%20work%20under%20Linux%2C%20X.org" target="_blank"><i class="fa fa-reddit-square" aria-hidden="true"></i></a>
        <a href="https://news.ycombinator.com/submitlink?t=Make%20your%20Apple%20Aluminium%20Keyboard%20really%20work%20under%20Linux%2C%20X.org&u=https%3A//dciabrin.net/posts/2009/05/make-your-apple-aluminium-keyboard-really-work-under-linux-xorg.html" target="_blank"><i class="fa fa-y-combinator-square" aria-hidden="true"></i></a>
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//dciabrin.net/posts/2009/05/make-your-apple-aluminium-keyboard-really-work-under-linux-xorg.html&title=Make%20your%20Apple%20Aluminium%20Keyboard%20really%20work%20under%20Linux%2C%20X.org&summary=Like%20many%20others%2C%20I%27ve%20bought%20an%20Aluminium%20Keyboard%20for%20~~its%20cool%0Astyle~~%20the%20smooth%20typing%20experience%20it%20provides.%20Mine%20is%20a%20wired%0Aversion%2C%20ISO%20variant%20%28international%2C%20110-keys%29.%20It%27s%20not%20working%20100%25%0Aout-of-the-box%20under%20Linux%2C%20so%20this%20post%20explains%20what%20I%20did%20to%20make%20it%0Ahappen%3A%0A%0A%0ASupporting%20the%20additional%20keys%20%28F13%20%E2%80%A6&source=https%3A//dciabrin.net/posts/2009/05/make-your-apple-aluminium-keyboard-really-work-under-linux-xorg.html" target="_blank"><i class="fa fa-linkedin-square" aria-hidden="true"></i></a>
        <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//dciabrin.net/posts/2009/05/make-your-apple-aluminium-keyboard-really-work-under-linux-xorg.html" target="_blank"><i class="fa fa-facebook-square" aria-hidden="true"></i></a>
        <a href="mailto:?subject=Make%20your%20Apple%20Aluminium%20Keyboard%20really%20work%20under%20Linux%2C%20X.org&amp;body=https%3A//dciabrin.net/posts/2009/05/make-your-apple-aluminium-keyboard-really-work-under-linux-xorg.html" target="_blank"><i class="fa fa-envelope-square" aria-hidden="true"></i></a>
      </div>
    </div>
    <hr />

<!--  -->
<nav class="nav-articles row justify-content-center">
    <div class="col-lg-10 col-md-12">
    <div class="row justify-content-center">
        <div class="col newer-article text-left">
            <div>Newer Post</div>
            <a aria-label="Previous" href="https://dciabrin.net/posts/2009/12/aluminium-keyboard-support-under-x11-all-models-all-oses.html">
              Aluminium Keyboard support under X11: all models, all OSes
            </a>
        </div>
        <div class="col text-center">
        </div>
        <div class="col older-article text-right">
            <div>Older Post</div>
            <a aria-label="Next" href="https://dciabrin.net/posts/2009/02/toolchainsh-is-amazing.html">
              Toolchain.sh is amazing!
            </a>
        </div>
    </div>
    </div>
</nav>
<!--  -->
    </div>

    <!-- <hr> -->

    <!-- Footer -->
    <footer>
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-md-12">
<p class="text-center copyright text-muted">
    Blog powered by <a href="http://getpelican.com">Pelican</a>,
    which takes great advantage of <a href="http://python.org">Python</a>. <br />        &copy;  Damien Ciabrini
  <br />
      <span class="fa-stack fa">
      <a href="http://twitter.com/dciabrin">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </a>
      </span>
      <span class="fa-stack fa">
      <a href="http://github.com/dciabrin">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </a>
      </span>
      <span class="fa-stack fa">
      <a href="https://www.linkedin.com/in/damien-ciabrini-70514187">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
      </a>
      </span>
</p>                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="https://dciabrin.net/theme/js/jquery.min.js"></script>

    <!-- Parallax -->
    <script src="https://dciabrin.net/theme/js/parallax.js?nocache"></script>
    <script>
      parallax('header-background');
    </script> 

    <!-- Bootstrap Core JavaScript -->
    <script src="https://dciabrin.net/theme/js/bootstrap.min.js"></script>

</body>

</html>