<!DOCTYPE html>
<html lang="en">
<head>
  
  <title>(blog-dump 'dciabrin) &mdash; Troubleshooting open_files_limit in MariaDB</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1" />

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>

  <link rel="stylesheet" type="text/css" href="http://damien.ciabrini.name/theme/lingonberry/css/style.css" />
  <link rel="stylesheet" type="text/css" href="http://damien.ciabrini.name/theme/tipuesearch/css/tipuesearch.css" />
  <link rel="stylesheet" type="text/css" href="http://damien.ciabrini.name/theme/css/blogdump.css" />
  <link rel="stylesheet" type="text/css" href="http://damien.ciabrini.name/theme/css/slide.css" />
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Oswald&#038;ver=3.3.2"/> 
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Inconsolata" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  <link rel="alternate" type="application/atom+xml"
	title="(blog-dump 'dciabrin) — Atom Feed"
	href="http://damien.ciabrini.name/" /> 
</head>

<body id="body" class="homez blogz" >
  <div id="page">
    <header id="header" class="header section">
        <div class="header-inner section-inner">
            <a class="site-logo noimg" rel="home" title="(blog-dump 'dciabrin)" href="http://damien.ciabrini.name">
                <span class="screen-reader-text"></span>
            </a>
	    <h1 id="site-title" class="site-title">
              <a href="http://damien.ciabrini.name">(blog-dump 'dciabrin)</a>
              <a href="#" id="toggle-menu">☰</a>
            </h1>
<h2 id="site-description" class="site-description">A coding and hacking diary</h2>        </div>
    
    <nav id="header-nav" class="site-navigation">
        <form class="navbar-search" action="http://damien.ciabrini.name/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form>
	<div class="menu-navigation-container"><div class="navigation-inner section-inner">
	    <ul id="menu-navigation" class="blog-menu">
		<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/">Home</a></li>
		    <li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://damien.ciabrini.name/pages/about.html">About</a></li>

			<li class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://damien.ciabrini.name/category/code.html">Code</a></li>
			<li class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://damien.ciabrini.name/category/misc.html">Misc</a></li>

			<li  class="active" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="/archives.html">Archives</a></li>


	    </ul>
	</div></div> <!--/#menu-navigation-container-->
    </nav><!-- /#menu -->
    </header><!-- /#banner -->
		                    
    <!-- <div id="full"> -->
    <!-- Content -->
    <div class="flexcontent">
    <main class="article">
        <section class="post type-post status-publish format-standard hentry category-general" id="post">
	    <div class="main content-inner">
	        <!-- <div class="post-header"> -->
		<h1 class="post-title">
		    <a href="http://damien.ciabrini.name/posts/2016/03/troubleshooting-open_files_limit-in-mariadb.html" title="Permalink to Troubleshooting open_files_limit in MariaDB" rel="bookmark">Troubleshooting open_files_limit in MariaDB</a>
		</h1>
		<div class="center post-meta"><span>Damien Ciabrini</span></div>
                <div class="center post-meta">
                    <i class="fa fa-calendar"></i> <a href="http://damien.ciabrini.name/posts/2016/03/troubleshooting-open_files_limit-in-mariadb.html">Tue 22 March 2016</a>
                        <span class="sep"></span>
    	                <span class="tag-links"><i class="fa fa-tags"></i>
 <a href="http://damien.ciabrini.name/tag/galera.html" rel="tag">galera</a>,  <a href="http://damien.ciabrini.name/tag/mariadb.html" rel="tag">mariadb</a>    	                </span>
                </div>
                
                <div class="entry-content">
		    <p>It may happen in the MariaDB logs that you see failures to set <code>open_files_limit</code>:</p>
<div class="highlight"><pre>160318 21:48:04 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
160318 21:48:04 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
160318 21:48:04 [Warning] Could not increase number of max_open_files to more than 1024 (request: 4907)
</pre></div>


<p>Meaning MariaDB was unable to raise the limit of maximum file descriptors at startup, with all the subsequent problems it can cause. Sometimes it is simply due to a bad setting in configuration files, such as:</p>
<div class="highlight"><pre>open_files_limit=-1
</pre></div>




<h2>How MariaDB processes option open_files_limit</h2>
<p>When started, MariaDB follows an internal logics to set the limit of file descriptor to use at run-time: </p>
<ul>
<li>
<p>It computes the minimum number of <em>wanted_files</em>, whichever is the biggest from:</p>
<ul>
<li>fd needed by MariaDB and innodb (based on some heuristics)</li>
<li>5 * max_connections as set in config file</li>
</ul>
</li>
<li>
<p>It sets the new process limit (<code>setrlimit</code>) to whichever is the biggest:</p>
<ul>
<li><em>wanted_files</em> as computed above</li>
<li>or value of option <code>open_files_limit</code> (e.g. set in server.cnf)</li>
</ul>
</li>
</ul>
<p>Now, if the MariaDB configuration files contain a line like:</p>
<div class="highlight"><pre>open_files_limit=-1
</pre></div>


<p>The signed value will be adjusted automatically by MariaDB to match the expected uint range:</p>
<div class="highlight"><pre>160105  9:10:50 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
160105  9:10:50 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
</pre></div>


<p>The side effect is that <code>setrlimit</code> will now be called with 4294967295, which fails with <code>EPERM</code><sup id="fnref:eperm"><a class="footnote-ref" href="#fn:eperm" rel="footnote">1</a></sup> even when run as root because the requested value which is above system limits. The per-process limit will thus stick to the default, which is usually 1024 fd. MariaDB will signal the failure by logging the value originally computed for <em>wanted_files</em>:</p>
<div class="highlight"><pre>160105  9:10:50 [Warning] Could not increase number of max_open_files to more than 1024 (request: 9003)
</pre></div>


<h2>Config file or command line</h2>
<p>One noteworthy detail is that one can ask MariaDB to raise the file descriptors limit at the command line as well, with argument <code>--open-files-limit=XXX</code>. In fact, at MariaDB startup, <code>mysqld_safe</code> scans both configuration file and command line for option <code>open_files_limit</code> and if found, it will pass that value<sup id="fnref:config"><a class="footnote-ref" href="#fn:config" rel="footnote">2</a></sup> explicitly at command line when it spawns the <code>mysqld</code> server.</p>
<p>The <code>mysqld</code> server itself first parses options specified in the configuration files, and after that those coming from the command line. Given the way <code>mysqld_safe</code> parses option <code>open_files_limit</code>, you can see that the <code>mysqld</code> server will parse the option twice if it comes from the configuration file.</p>
<h2>Concrete examples from the logs</h2>
<p>Back to the original example from this article:</p>
<div class="highlight"><pre>160318 21:48:04 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
160318 21:48:04 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
160318 21:48:04 [Warning] Could not increase number of max_open_files to more than 1024 (request: 4907)
</pre></div>


<p>You can extract from those logs that option <code>open_files_limit</code> was set to -1 somewhere in the config files, and that no command line option <code>--open-files-limit</code> was passed to <code>mysqld_safe</code> to override it. When parsing the options, <code>mysqld</code> logged a bound check warning for the value coming from the configuration file, and another one for the value forwarded by <code>mysqld_safe</code> via the command line. Corrected value was too high for <code>setrlimit</code>, which consequently failed.</p>
<p>Another pattern that can arise is when MariaDB is used with Galera replication. At startup, <code>mysqld_safe</code> needs to run <code>mysqld</code> once with special flags to recover the replication position of the galera node. It then start <code>mysqld</code> a second time with the proper replication start position. This has the effect of having twice as many warning messages in the logs.</p>
<div class="highlight"><pre>160322 13:07:14 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql
160322 13:07:14 mysqld_safe WSREP: Running position recovery with --log_error=&#39;/var/lib/mysql/wsrep_recovery.uuL8VZ&#39; --pid-file=&#39;/var/lib/mysql/db2-recover.pid&#39;
160322 13:07:14 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
160322 13:07:14 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
160322 13:07:14 [Warning] Could not increase number of max_open_files to more than 1024 (request: 2859)
160322 13:07:16 mysqld_safe WSREP: Recovered position c87b7e3e-ec54-11e5-92b3-16a45d02f190:5
160322 13:07:16 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
160322 13:07:16 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
160322 13:07:16 [Note] WSREP: wsrep_start_position var submitted: &#39;c87b7e3e-ec54-11e5-92b3-16a45d02f190:5&#39;
160322 13:07:16 [Warning] Could not increase number of max_open_files to more than 1024 (request: 2859)
</pre></div>


<p>If MariaDB/Galera is started with a valid <code>--open-files-limit</code> argument at the command line, you will only see one bound check warning in the logs per mysqld run:</p>
<div class="highlight"><pre>160322 13:23:22 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql
160322 13:23:22 mysqld_safe WSREP: Running position recovery with --log_error=&#39;/var/lib/mysql/wsrep_recovery.WAKIoR&#39; --pid-file=&#39;/var/lib/mysql/db2-recover.pid&#39;
160322 13:23:22 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
160322 13:23:24 mysqld_safe WSREP: Recovered position c87b7e3e-ec54-11e5-92b3-16a45d02f190:5
160322 13:23:24 [Warning] option &#39;open_files_limit&#39;: unsigned value 18446744073709551615 adjusted to 4294967295
</pre></div>


<h2>Checking whether open_files_limit setting is active</h2>
<p>In order to change <code>open_files_limit</code>, you should start MariaDB as root and use option <code>--user</code> to let <code>mysqld</code> switch to the requested user after setting limits. If you don't see complaints in the logs, <code>open_files_limit</code> setting should be applied. Under Linux, a quick means of verifying that is to probe the running <code>mysqld</code> process:</p>
<div class="highlight"><pre># cat /proc/$(pidof /usr/libexec/mysqld)/limits | grep -e Limit -e &#39;open files&#39;
Limit                     Soft Limit           Hard Limit           Units
Max open files            10245                10245                files
</pre></div>


<p>Likewise, the <code>mysql</code> client will return the limit that has been successfully set:</p>
<div class="highlight"><pre># mysql -e &quot;SHOW VARIABLES LIKE &#39;open_files_limit&#39;;&quot;
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| open_files_limit | 10245 |
+------------------+-------+
</pre></div>


<p>Don't be surprised if you don't see the exact value you specified for <code>open_files_limit</code>. Remember that MariaDB will call <code>setrlimit</code> with the highest value between <em>wanted_files</em> and <code>open_files_limit</code>.</p>
<p>If <code>Soft Limit</code> or the <code>mysql</code> client reports something like 1024, that means <code>mysqld</code> did not raise the maximum file descriptor limit appropriately, and the logs should contain enough information to find out why.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:eperm">
<p>From setrlimit man: EPERM  The caller tried to increase the hard RLIMIT_NOFILE limit above the maximum defined by /proc/sys/fs/nr_open (see proc(5))&#160;<a class="footnote-backref" href="#fnref:eperm" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:config">
<p>If set in configuration file and at the command line, the latter takes precedence over the former&#160;<a class="footnote-backref" href="#fnref:config" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>

		</div> <!--/#entry-content-->
	    </div> <!--/#main-->
        </section>  <!--/#post-->
        <div class="hidden">
<aside id="menu" class="side_navigation">
  <h3 class="nav_author">Damien Ciabrini</h3>

  <p>Coder, hacker, dreamer. Worked on compilers,
    debuggers, language runtimes. Passionate
    about distributed computing. Obsessed by
    retro hardware and optimizations.
    <div class="center social-buttons">
        <a class="social fa fa-twitter" href="http://twitter.com/dciabrin"></a>
        <!-- <span class="sep"></span> -->
        <a class="social fa fa-github" href="http://github.com/dciabrin"></a>
        <!-- <span class="sep"></span> -->
        <a class="social fa fa-google-plus" href="https://plus.google.com/+DamienCiabrini"></a>
        <!-- <span class="sep"></span> -->
        <a class="social fa fa-linkedin" href="https://www.linkedin.com/in/damien-ciabrini-70514187"></a>
        <!-- <span class="sep"></span> -->
    </div>
  </p>
    
  <h3>Meta</h3>
  <div class="center">
  <ul>
      <li><a href="http://damien.ciabrini.name/" type="application/atom+xml" rel="alternate" title="ATOM Feed" />Blog Feed <i class="fa fa-rss"></i></a></li>
  </ul>
  </div>
  
  <h3>Categories</h3>
  <div class="center">
  <ul>
        <li><a href="http://damien.ciabrini.name/category/code.html">Code</a> (9)</li>
        <li><a href="http://damien.ciabrini.name/category/misc.html">Misc</a> (1)</li>
  </ul>
  </div>
</aside>        </div>
	<section id="comments">
		<div id="respond">
			<div id="disqus_thread"></div>
	        <script type="text/javascript">
	            var disqus_shortname = 'dciabrin';
	
	            /* * * DON'T EDIT BELOW THIS LINE * * */
	            (function() {
	                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	            })();
	        </script>
	        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		</div><!-- #respond -->					
        </section><!-- #comments -->
    </main>

    </div>
    <!-- Footer -->
<footer id="footer" class="footer">
  <div class="section-inner">
    &copy; 2008&dash;2015 Damien Ciabrini - Content licensed under <a href="CC-BY 4.0">CC-BY 4.0</a> unless stated otherwise.<br/>
    Theme based on <a href="https://wordpress.com/themes/lingonberry/">Lingonberry</a>,
    icons by <a href="https://fortawesome.github.io/Font-Awesome/">Font Awesome</a><br/>
    Powered by <a href="http://getpelican.com">Pelican</a>, <a href="https://disqus.com">Disqus</a><br/>

<script type="text/javascript">
    var disqus_shortname = 'dciabrin';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>  </div>
</footer><!-- /#footer -->    </div>
  <!-- </div> -->
  <script src="http://damien.ciabrini.name/theme/slide.js"></script>
</body>
</html>